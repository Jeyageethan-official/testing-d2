
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Work Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- PDF/Image Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-dark: #030712;  /* gray-950 */
            --slt-blue: #3b82f6; 
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
            color: #1f2937; /* Default text color for light mode */
        }
        html.dark body {
             color: #d1d5db; /* Default text for dark */
        }

        /* --- Animated Gradient Background --- */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(125deg, #e0f7fa, #f0e6ff, #d1e9ff, #fde2e4);
            background-size: 400% 400%;
            animation: gradient-animation 25s ease infinite;
            z-index: -1;
            transition: opacity 0.5s ease;
        }
        html.dark body::before {
            background: linear-gradient(125deg, #020617, #1e1b4b, #1e3a8a, #4a044e);
            background-size: 400% 400%;
            animation: gradient-animation 25s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* General Transitions & Micro-interactions */
        .transition-all-ease {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }
        .interactive-lift {
             transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .interactive-lift:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
        }
        .interactive-bounce:active {
            transform: scale(0.97);
            transition: transform 0.1s ease-in;
        }

        /* Webkit scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb80; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        html.dark ::-webkit-scrollbar-track { background: #1f293780; }
        html.dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Page fade-in/out animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-view { display: none; }
        .page-view.active { display: block; animation: fadeInUp 0.5s ease-out forwards; }
        .page-view.fade-out { animation: fadeOut 0.3s ease-in forwards; }

        /* Modal animations */
        @keyframes modal-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content-animate { animation: modal-in 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .modal-bg-animate { animation: fadeIn 0.3s ease-out forwards; }

        /* Premium input focus glow */
        .premium-input:focus, .premium-select:focus {
             border-color: var(--slt-blue);
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
             outline: none;
        }
        html.dark .premium-input:focus, html.dark .premium-select:focus {
             border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        /* Custom select arrow */
        .premium-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        html.dark .premium-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        
        /* Card style with glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        html.dark .glass-card {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Sign-in Page specific styles */
        .signin-glowing-btn {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4), 0 0 20px rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }
        .signin-glowing-btn:hover {
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.6), 0 0 30px rgba(96, 165, 250, 0.4);
        }

        /* Bar Graph Animation */
        .bar {
            transform-origin: bottom;
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            transform: scaleY(0);
        }
        .bar-loaded { transform: scaleY(1); }
        
        /* --- Settings Toggle Switch --- */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #3b82f6; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Utility classes */
        .hidden { display: none; }
        .break-words { word-break: break-word; }
        .day-card-menu-dropdown { position: absolute; top: 100%; right: 0; z-index: 10; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 6px; min-width: 150px; animation: fadeIn 0.1s ease-out; border: 1px solid #e5e7eb; }
        html.dark .day-card-menu-dropdown { background: #1f2937; border-color: #374151; }
        .day-card-menu-item { padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: background-color: 0.2s; }
        .day-card-menu-item:hover { background: #f1f5f9; }
        html.dark .day-card-menu-item:hover { background: #374151; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
    </style>
<script type="importmap">
{
  "imports": {
    "firebase/": "https://aistudiocdn.com/firebase@^12.4.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^0.14.0"
  }
}
</script>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-800 dark:text-gray-200">
    
    <!-- Ambient Music Player -->
    <audio id="ambient-music" loop>
        <source src="https://www.chosic.com/wp-content/uploads/2022/01/nature-forest-with-birds-singing.mp3" type="audio/mpeg">
    </audio>

    <!-- App Wrapper -->
    <div id="app-root">

        <!-- Full Screen Sign-In Page -->
        <div id="signin-page" class="page-view min-h-screen w-full flex flex-col items-center justify-center p-4 transition-all-ease">
            <div class="w-full max-w-md space-y-8">
                <div class="text-center">
                    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white">Work Report</h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">Sign in to continue to your dashboard</p>
                </div>
                <div id="auth-container" class="glass-card p-8 rounded-2xl">
                    <!-- Auth Forms will be rendered here by JS -->
                </div>
            </div>
        </div>

        <!-- Main App Container (Dashboard & Report) -->
        <div id="main-app" class="page-view">
             <nav class="bg-white/30 dark:bg-gray-900/30 backdrop-blur-lg sticky top-0 z-30 shadow-sm border-b border-white/20 dark:border-gray-800/50">
                <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <span id="nav-title" class="text-xl font-bold text-gray-900 dark:text-white">Dashboard</span>
                        </div>
                        <div id="auth-area" class="flex items-center gap-4">
                            <!-- Auth status rendered here -->
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="page-view">
                 <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Main Content Column -->
                        <div class="lg:col-span-2 space-y-8">
                            <section id="weekly-graph-container"></section>
                             <div class="glass-card rounded-2xl p-6 text-center">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Manage Your Work</h2>
                                <p class="mt-2 text-gray-600 dark:text-gray-400">View and edit your detailed monthly work report.</p>
                                <button id="go-to-report-btn" class="mt-4 inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 interactive-lift interactive-bounce">
                                    View Full Report
                                </button>
                            </div>
                        </div>

                        <!-- Sidebar Column -->
                        <aside class="lg:col-span-1 space-y-6 lg:sticky lg:top-24 h-max">
                            <div id="profile-card-container"></div>
                            <div id="today-summary-container"></div>
                            <div id="quick-actions-container"></div>
                            <div id="settings-container"></div>
                        </aside>
                    </div>
                </div>
            </div>
            
            <!-- Report View -->
            <div id="report-view" class="page-view">
                <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
                    <header id="report-header-container" class="glass-card rounded-2xl p-4 mb-8"></header>
                    <main>
                        <div id="daysContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                    </main>
                    <div id="summary-container" class="mt-8"></div>
                </div>
            </div>

        </div>

    </div> <!-- End #app-root -->

    <!-- Modals Portal -->
    <div id="modal-root"></div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-100 dark:bg-gray-950 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-center">
             <svg class="h-12 w-12 text-blue-600 dark:text-blue-400 animate-spin mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-300">Loading Report...</p>
        </div>
    </div>

<script type="module">
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    updateProfile,
    GoogleAuthProvider,
    signInWithPopup,
    sendPasswordResetEmail
} from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteField } from 'firebase/firestore';
import { GoogleGenAI } from "@google/genai";

const applyTheme = (theme) => {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
    } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
    }
};

const initTheme = () => {
    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme) applyTheme(savedTheme);
    else if (systemPrefersDark) applyTheme('dark');
    else applyTheme('light');
};
initTheme();

document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & GLOBALS ---
    let user = null;
    let currentDate = new Date();
    let workData = {};
    let reminders = [];
    let settings = { soundEnabled: true, musicEnabled: false };
    let currentView = 'dashboard';
    
    const firebaseConfig = {
      apiKey: process.env.API_KEY,
      authDomain: "work-report-f2913.firebaseapp.com",
      projectId: "work-report-f2913",
      storageBucket: "work-report-f2913.appspot.com",
      messagingSenderId: "367332308960",
      appId: "1:367332308960:web:1e4c8c72f159585a975662"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    // --- DOM Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const signinPage = document.getElementById('signin-page');
    const mainApp = document.getElementById('main-app');
    const dashboardView = document.getElementById('dashboard-view');
    const reportView = document.getElementById('report-view');
    const navTitle = document.getElementById('nav-title');
    
    const authContainer = document.getElementById('auth-container');
    const authArea = document.getElementById('auth-area');
    
    // Dashboard widgets
    const weeklyGraphContainer = document.getElementById('weekly-graph-container');
    const profileCardContainer = document.getElementById('profile-card-container');
    const todaySummaryContainer = document.getElementById('today-summary-container');
    const quickActionsContainer = document.getElementById('quick-actions-container');
    const settingsContainer = document.getElementById('settings-container');

    // Report components
    const reportHeaderContainer = document.getElementById('report-header-container');
    const daysContainer = document.getElementById('daysContainer');
    const summaryContainer = document.getElementById('summary-container');
    
    const modalRoot = document.getElementById('modal-root');
    const ambientMusic = document.getElementById('ambient-music');

    // --- SOUND MANAGER ---
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const soundManager = {
        play: (type) => {
            if (!settings.soundEnabled || !audioContext) return;
            let osc, gain;
            audioContext.resume();
            switch(type) {
                case 'click':
                    osc = audioContext.createOscillator(); gain = audioContext.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioContext.currentTime); gain.gain.setValueAtTime(0.1, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1); osc.connect(gain); gain.connect(audioContext.destination); osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime + 0.1); break;
                case 'navigate':
                    osc = audioContext.createOscillator(); gain = audioContext.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(200, audioContext.currentTime); osc.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.1); gain.gain.setValueAtTime(0.08, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1); osc.connect(gain); gain.connect(audioContext.destination); osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime + 0.1); break;
                case 'whoosh':
                    gain = audioContext.createGain(); const noise = audioContext.createBufferSource(); const buffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.3, audioContext.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1; noise.buffer = buffer; const filter = audioContext.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(8000, audioContext.currentTime); filter.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.3); noise.connect(filter); filter.connect(gain); gain.connect(audioContext.destination); noise.start(audioContext.currentTime); noise.stop(audioContext.currentTime + 0.3); break;
                case 'success':
                    gain = audioContext.createGain(); gain.gain.setValueAtTime(0.1, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5); gain.connect(audioContext.destination); osc = audioContext.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioContext.currentTime); osc.connect(gain); osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime + 0.1); setTimeout(() => { const osc2 = audioContext.createOscillator(); osc2.type = 'sine'; osc2.frequency.setValueAtTime(783.99, audioContext.currentTime); osc2.connect(gain); osc2.start(audioContext.currentTime); osc2.stop(audioContext.currentTime + 0.2); }, 100); break;
            }
        }
    };

    // --- VIEW MANAGEMENT ---
    const showPage = (pageId) => {
        const pages = [signinPage, mainApp];
        const activePage = document.getElementById(pageId);
        
        pages.forEach(page => {
            if (page !== activePage && !page.classList.contains('hidden')) {
                page.classList.add('fade-out');
                setTimeout(() => page.classList.add('hidden'), 300);
            }
        });

        if (activePage) {
            activePage.classList.remove('hidden', 'fade-out');
            activePage.classList.add('active');
        }
    };

    const showView = (viewId) => {
        soundManager.play('whoosh');
        const views = [dashboardView, reportView];
        const activeView = document.getElementById(viewId);
        
        views.forEach(view => {
            if (view !== activeView && view.classList.contains('active')) {
                view.classList.add('fade-out');
                setTimeout(() => {
                    view.classList.remove('active');
                    view.classList.remove('fade-out');
                }, 300);
            }
        });
        
        setTimeout(() => {
            if (activeView) {
                activeView.classList.add('active');
                currentView = viewId.replace('-view', '');
                navTitle.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);
                 if(currentView === 'report') {
                    renderReportPage();
                } else {
                    renderDashboardPage();
                }
            }
        }, 150);
    };

    // --- UTILITY FUNCTIONS ---
    const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
    const isWeekend = (year, month, day) => { const d = new Date(year, month, day).getDay(); return d === 0 || d === 6; };
    const calculateHoursDifference = (inTime, outTime) => {
        if (!inTime || !outTime) return 0;
        const [inH, inM] = inTime.split(':').map(Number);
        const [outH, outM] = outTime.split(':').map(Number);
        const inMinutes = inH * 60 + inM;
        const outMinutes = outH * 60 + outM;
        if (outMinutes < inMinutes) return 0; // Handle overnight case if needed
        return (outMinutes - inMinutes) / 60;
    };
    const getGreeting = () => {
        const hour = new Date().getHours();
        if (hour < 12) return "Good morning";
        if (hour < 18) return "Good afternoon";
        return "Good evening";
    };

    // --- MODAL MANAGEMENT ---
    const openModal = (modalHTML) => {
        soundManager.play('whoosh');
        modalRoot.innerHTML = modalHTML;
        modalRoot.querySelectorAll('[data-dismiss="modal"]').forEach(el => el.addEventListener('click', closeModal));
    };
    const closeModal = () => { modalRoot.innerHTML = ''; };
    const createModal = (title, content, id = '') => `
        <div id="${id}" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 p-4 modal-bg-animate" data-dismiss="modal">
            <div class="glass-card rounded-2xl shadow-2xl w-full max-w-md transform transition-all modal-content-animate" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center p-6 border-b border-gray-200/50 dark:border-gray-800/50">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${title}</h2>
                    <button data-dismiss="modal" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
                <div class="p-6">${content}</div>
            </div>
        </div>`;
    const showInfoModal = (title, message) => openModal(createModal(title, `<p class="text-gray-600 dark:text-gray-400 text-center">${message}</p>`));

    // --- AUTH VIEWS ---
    const renderSignInForm = () => {
        authContainer.innerHTML = `
            <form id="login-form" autocomplete="on" class="space-y-6">
                <div><label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Address</label><input id="auth-email" type="email" autocomplete="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none premium-input dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 bg-white/50 dark:bg-gray-900/50" /></div>
                <div><label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label><input id="auth-password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none premium-input dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 bg-white/50 dark:bg-gray-900/50" /></div>
                <div class="flex items-center justify-end"><button type="button" id="forgot-password-btn" class="text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">Forgot password?</button></div>
                <p id="auth-error" class="text-red-500 text-sm h-4"></p>
                <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none signin-glowing-btn interactive-bounce">Sign In</button></div>
                <div class="relative my-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-700"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white/70 dark:bg-gray-900/70 text-gray-500 backdrop-blur-xl">Or</span></div></div>
                <button type="button" id="google-login" class="w-full flex items-center justify-center gap-3 px-5 py-2.5 rounded-lg font-semibold text-sm shadow-sm transition-all transform hover:scale-[1.03] bg-white text-gray-800 border border-gray-300 hover:bg-gray-100 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-700"><svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>Sign in with Google</button>
                <p class="text-center text-sm text-gray-600 dark:text-gray-400">Not a member? <button type="button" id="show-signup-btn" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">Sign up</button></p>
            </form>
        `;
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('google-login').addEventListener('click', handleGoogleLogin);
        document.getElementById('forgot-password-btn').addEventListener('click', handleForgotPassword);
        document.getElementById('show-signup-btn').addEventListener('click', () => { soundManager.play('click'); renderSignUpForm(); });
    };

    const renderSignUpForm = () => {
        authContainer.innerHTML = `
            <form id="signup-form" autocomplete="on" class="space-y-4">
                 <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label><input id="signup-name" type="text" autocomplete="name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm premium-input dark:bg-gray-800 dark:border-gray-700 bg-white/50 dark:bg-gray-900/50" /></div>
                 <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Address</label><input id="signup-email" type="email" autocomplete="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm premium-input dark:bg-gray-800 dark:border-gray-700 bg-white/50 dark:bg-gray-900/50" /></div>
                 <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label><input id="signup-password" type="password" autocomplete="new-password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm premium-input dark:bg-gray-800 dark:border-gray-700 bg-white/50 dark:bg-gray-900/50" /></div>
                 <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm Password</label><input id="signup-confirm-password" type="password" autocomplete="new-password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm premium-input dark:bg-gray-800 dark:border-gray-700 bg-white/50 dark:bg-gray-900/50" /></div>
                <p id="signup-error" class="text-red-500 text-sm h-4"></p>
                <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none signin-glowing-btn interactive-bounce">Create Account</button></div>
                <p class="text-center text-sm text-gray-600 dark:text-gray-400">Already a member? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">Sign In</button></p>
            </form>
        `;
        document.getElementById('signup-form').addEventListener('submit', handleSignUp);
        document.getElementById('show-login-btn').addEventListener('click', () => { soundManager.play('click'); renderSignInForm(); });
    };

    // --- DASHBOARD WIDGET RENDERERS ---
    const renderAuthArea = () => {
        if (!user) {
            authArea.innerHTML = ''; return;
        }
        authArea.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="flex items-center justify-center h-10 w-10 bg-gradient-to-br from-blue-400 to-indigo-600 rounded-full text-white text-lg font-bold uppercase">
                    ${user.displayName ? user.displayName.charAt(0) : user.email.charAt(0)}
                </div>
                <button id="logout-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200/50 dark:bg-gray-700/50 dark:text-gray-200 rounded-lg hover:bg-gray-300/50 dark:hover:bg-gray-600/50 interactive-bounce">Logout</button>
            </div>
        `;
        document.getElementById('logout-btn').addEventListener('click', () => {
            soundManager.play('click');
            signOut(auth);
        });
    };
    
    const renderProfileCard = () => {
        if (!user) return profileCardContainer.innerHTML = '';
        profileCardContainer.innerHTML = `
            <div class="glass-card rounded-2xl p-6 text-center">
                <h3 class="mt-4 text-xl font-bold text-gray-900 dark:text-white">${getGreeting()}</h3>
                <p class="text-gray-600 dark:text-gray-400">${user.displayName || user.email}</p>
            </div>
        `;
    };

    const renderTodaySummary = () => {
        const today = new Date();
        const dateKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
        const todayData = workData[dateKey] || {};
        const hoursWorked = calculateHoursDifference(todayData.inTime, todayData.outTime);
        todaySummaryContainer.innerHTML = `
            <div class="glass-card rounded-2xl p-6">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4">Today's Log</h3>
                ${Object.keys(todayData).length === 0 ? `<p class="text-center text-gray-500 dark:text-gray-400 py-4">No data entered for today.</p>` : `
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">In Time:</span><span class="font-semibold text-gray-800 dark:text-gray-200">${todayData.inTime || '--:--'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Out Time:</span><span class="font-semibold text-gray-800 dark:text-gray-200">${todayData.outTime || '--:--'}</span></div>
                    <div class="flex justify-between pt-2 border-t border-gray-200/50 dark:border-gray-700/50"><span class="text-gray-600 dark:text-gray-400">Total Hours:</span><span class="font-bold text-blue-600 dark:text-blue-400">${hoursWorked.toFixed(2)}h</span></div>
                </div>
                `}
            </div>`;
    };

    const renderQuickActions = () => {
        quickActionsContainer.innerHTML = `
            <div class="glass-card rounded-2xl p-6">
                 <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4">Quick Actions</h3>
                 <div class="grid grid-cols-2 gap-3">
                    <button id="quick-backup" class="flex flex-col items-center justify-center p-3 bg-white/50 dark:bg-gray-800/50 rounded-xl hover:bg-white dark:hover:bg-gray-700 interactive-lift interactive-bounce"><svg class="w-6 h-6 mb-1 text-green-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span class="text-xs font-semibold">Backup</span></button>
                    <button id="quick-sync" class="flex flex-col items-center justify-center p-3 bg-white/50 dark:bg-gray-800/50 rounded-xl hover:bg-white dark:hover:bg-gray-700 interactive-lift interactive-bounce"><svg class="w-6 h-6 mb-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg><span class="text-xs font-semibold">Sync</span></button>
                 </div>
            </div>`;
        document.getElementById('quick-backup').addEventListener('click', () => { soundManager.play('click'); handleBackup(); });
        document.getElementById('quick-sync').addEventListener('click', () => { soundManager.play('success'); showInfoModal('Sync Status', 'Your data is automatically synced with the cloud.'); });
    };

    const renderSettings = () => {
        settingsContainer.innerHTML = `
            <div class="glass-card rounded-2xl p-6">
                 <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4">Settings</h3>
                 <div class="space-y-4">
                    <div class="flex justify-between items-center"><label for="sound-toggle" class="text-gray-700 dark:text-gray-300">Sound Effects</label><label class="toggle-switch"><input type="checkbox" id="sound-toggle" ${settings.soundEnabled ? 'checked' : ''}><span class="toggle-slider"></span></label></div>
                    <div class="flex justify-between items-center"><label for="music-toggle" class="text-gray-700 dark:text-gray-300">Ambient Music</label><label class="toggle-switch"><input type="checkbox" id="music-toggle" ${settings.musicEnabled ? 'checked' : ''}><span class="toggle-slider"></span></label></div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-200/50 dark:border-gray-700/50"><label for="theme-toggle" class="text-gray-700 dark:text-gray-300">Dark Mode</label><label class="toggle-switch"><input type="checkbox" id="theme-toggle" ${localStorage.getItem('theme') === 'dark' ? 'checked' : ''}><span class="toggle-slider"></span></label></div>
                 </div>
            </div>`;
        document.getElementById('sound-toggle').addEventListener('change', (e) => { settings.soundEnabled = e.target.checked; localStorage.setItem('appSettings', JSON.stringify(settings)); soundManager.play('click'); });
        document.getElementById('music-toggle').addEventListener('change', (e) => { settings.musicEnabled = e.target.checked; localStorage.setItem('appSettings', JSON.stringify(settings)); soundManager.play('click'); if (settings.musicEnabled) { ambientMusic.play(); } else { ambientMusic.pause(); } });
        document.getElementById('theme-toggle').addEventListener('change', (e) => { soundManager.play('click'); applyTheme(e.target.checked ? 'dark' : 'light'); });
    };

    const renderWeeklyGraph = () => {
        const today = new Date(); const year = today.getFullYear(); const month = today.getMonth(); const dayOfWeek = today.getDay(); const weekStart = new Date(today); weekStart.setDate(today.getDate() - dayOfWeek);
        const weekData = Array(7).fill(0); const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for (let i=0; i<7; i++) { const day = new Date(weekStart); day.setDate(weekStart.getDate() + i); const dateKey = `${day.getFullYear()}-${day.getMonth()}-${day.getDate()}`; const dayData = workData[dateKey] || {}; weekData[i] = calculateHoursDifference(dayData.inTime, dayData.outTime); }
        const maxHours = Math.max(...weekData, 1);
        weeklyGraphContainer.innerHTML = `
            <div class="glass-card p-6 rounded-2xl">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4">This Week's Hours</h3>
                <div class="h-40 flex items-end justify-around gap-2 border-b-2 border-gray-300/50 dark:border-gray-700/50 pb-2">
                   ${weekData.map((hours, i) => `<div class="flex-1 flex flex-col items-center group"><div class="text-xs font-bold text-gray-600 dark:text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity mb-1">${hours.toFixed(1)}h</div><div title="${weekDays[i]}: ${hours.toFixed(2)} hrs" class="bar w-3/4 rounded-t-lg ${i === dayOfWeek ? 'bg-blue-500' : 'bg-gray-400 dark:bg-gray-600'}" style="height: ${(hours / maxHours) * 100}%;"></div></div>`).join('')}
                </div>
                <div class="flex justify-around mt-2 text-xs text-gray-500 dark:text-gray-400">
                   ${weekDays.map(day => `<span class="flex-1 text-center">${day}</span>`).join('')}
                </div>
            </div>`;
        setTimeout(() => { document.querySelectorAll('#weekly-graph-container .bar').forEach(bar => bar.classList.add('bar-loaded')); }, 100);
    };

    // --- REPORT PAGE RENDERERS ---
    const renderReportHeader = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const years = Array.from({length: 10}, (_, i) => year - 5 + i);
        reportHeaderContainer.innerHTML = `
            <div class="flex flex-wrap items-center justify-between gap-4">
                 <button id="back-to-dashboard-btn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200/50 dark:bg-gray-700/50 dark:text-gray-200 rounded-lg hover:bg-gray-300/50 dark:hover:bg-gray-600/50 interactive-bounce">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    Dashboard
                </button>
                <div class="flex items-center gap-2">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200/50 dark:hover:bg-gray-700/50 interactive-bounce"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                    <select id="monthDropdown" class="premium-select rounded-lg p-2 border-0 bg-transparent font-bold text-lg">${months.map((m, i) => `<option value="${i}" ${i === month ? 'selected' : ''}>${m}</option>`).join('')}</select>
                    <select id="yearDropdown" class="premium-select rounded-lg p-2 border-0 bg-transparent font-bold text-lg">${years.map(y => `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`).join('')}</select>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200/50 dark:hover:bg-gray-700/50 interactive-bounce"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="export-btn" class="px-4 py-2 text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 rounded-lg interactive-lift interactive-bounce">Export</button>
                    <button id="clear-month-btn" class="px-4 py-2 text-sm font-medium bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 rounded-lg interactive-lift interactive-bounce">Clear Month</button>
                </div>
            </div>`;
        addReportHeaderEventListeners();
    };

    const createDayCardHTML = (day) => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const dateKey = `${year}-${month}-${day}`;
        const dayData = workData[dateKey] || {};
        const dayName = new Date(year, month, day).toLocaleDateString("en-US", { weekday: "long" });
        const weekend = isWeekend(year, month, day);
        const createInput = (label, field, type, placeholder = '', value = '') => {
            const valueAttr = value ? `value="${value}"` : '';
            const inputHTML = `<input type="${type === 'time' ? 'text' : type}" ${type === 'time' ? 'readonly' : ''} placeholder="${placeholder}" ${valueAttr} data-key="${dateKey}" data-field="${field}" class="w-full mt-1 p-2.5 border border-gray-300 dark:border-gray-700/50 rounded-lg bg-gray-50/20 dark:bg-gray-800/20 transition duration-200 premium-input dark:text-gray-200 ${type === 'time' ? 'cursor-pointer' : ''}" ${type === 'number' ? 'min="0"' : ''} />`;
            return `<div><label class="font-medium text-sm text-gray-600 dark:text-gray-400">${label}</label>${inputHTML}</div>`;
        };
        return `
            <div data-day="${day}" class="day-box glass-card rounded-2xl p-5 interactive-lift">
                <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200/50 dark:border-gray-800/50">
                    <h3 class="text-xl font-bold ${weekend ? 'text-red-500 dark:text-red-400' : 'text-gray-900 dark:text-gray-100'}">${day}, ${dayName}</h3>
                    <button class="clear-day-btn p-1 text-gray-500 dark:text-gray-400 hover:text-red-500 rounded-full" title="Clear this day's data"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${createInput('In Time', 'inTime', 'time', '--:--', dayData.inTime)}
                        ${createInput('Out Time', 'outTime', 'time', '--:--', dayData.outTime)}
                    </div>
                    <div class="pt-3 border-t border-gray-200/50 dark:border-gray-800/50">
                       <textarea data-key="${dateKey}" data-field="description" placeholder="Add work description..." class="w-full mt-1 p-2.5 border border-gray-300 dark:border-gray-700/50 rounded-lg bg-gray-50/20 dark:bg-gray-800/20 transition duration-200 premium-input dark:text-gray-200 h-24 resize-none">${dayData.description || ''}</textarea>
                    </div>
                </div>
            </div>`;
    };
    
    const renderDays = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysCount = getDaysInMonth(year, month);
        daysContainer.innerHTML = Array.from({length: daysCount}, (_, i) => createDayCardHTML(i + 1)).join('');
        addDayCardEventListeners();
    };
    
    const renderSummary = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        let totalHours = 0, workDays = 0;
        for (const key in workData) {
            const [dataYear, dataMonth] = key.split('-').map(Number);
            if (dataYear === year && dataMonth === month) {
                const dayData = workData[key];
                const hours = calculateHoursDifference(dayData.inTime, dayData.outTime);
                if (hours > 0) {
                    totalHours += hours;
                    workDays++;
                }
            }
        }
        summaryContainer.innerHTML = `
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Monthly Summary</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">Total Hours</p><p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${totalHours.toFixed(2)}</p></div>
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">Work Days</p><p class="text-2xl font-bold">${workDays}</p></div>
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">Avg Hours/Day</p><p class="text-2xl font-bold">${(workDays > 0 ? totalHours / workDays : 0).toFixed(2)}</p></div>
                </div>
            </div>`;
    };

    // --- DATA HANDLING ---
    const updateWorkData = (dateKey, field, value) => {
        workData[dateKey] = workData[dateKey] || {};
        if (value) {
            workData[dateKey][field] = value;
        } else {
            delete workData[dateKey][field];
        }
        if (Object.keys(workData[dateKey]).length === 0) {
            delete workData[dateKey];
        }

        if (user) {
            const userRef = doc(db, "users", user.uid);
            const payload = { workData: { [dateKey]: workData[dateKey] || deleteField() } };
            setDoc(userRef, payload, { merge: true }).catch(err => console.error("Firestore update error:", err));
        } else {
            localStorage.setItem('workData', JSON.stringify(workData));
        }
        
        // Live update relevant UI parts
        if (currentView === 'report') {
            renderSummary();
        } else {
            renderTodaySummary();
            renderWeeklyGraph();
        }
    };

    const clearDayData = (day) => {
        soundManager.play('click');
        const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${day}`;
        delete workData[dateKey];
        if (user) {
            const userRef = doc(db, "users", user.uid);
            updateDoc(userRef, { [`workData.${dateKey}`]: deleteField() });
        } else {
            localStorage.setItem('workData', JSON.stringify(workData));
        }
        
        const dayBox = daysContainer.querySelector(`.day-box[data-day="${day}"]`);
        if (dayBox) {
            dayBox.outerHTML = createDayCardHTML(day);
            addSingleDayCardEventListeners(daysContainer.querySelector(`.day-box[data-day="${day}"]`));
        }
        renderSummary();
    };

    // --- EVENT LISTENERS ---
    const addReportHeaderEventListeners = () => {
        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => showView('dashboard-view'));
        document.getElementById('prev-month-btn').addEventListener('click', () => navigateMonth(-1));
        document.getElementById('next-month-btn').addEventListener('click', () => navigateMonth(1));
        document.getElementById('monthDropdown').addEventListener('change', (e) => { soundManager.play('click'); currentDate.setMonth(parseInt(e.target.value)); renderReportPage(); });
        document.getElementById('yearDropdown').addEventListener('change', (e) => { soundManager.play('click'); currentDate.setFullYear(parseInt(e.target.value)); renderReportPage(); });
        document.getElementById('export-btn').addEventListener('click', () => { soundManager.play('click'); showExportPreview(); });
        document.getElementById('clear-month-btn').addEventListener('click', () => { soundManager.play('click'); handleClearMonthData(); });
    };

    const addSingleDayCardEventListeners = (dayBox) => {
        dayBox.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
            input.addEventListener('change', (e) => updateWorkData(e.target.dataset.key, e.target.dataset.field, e.target.value));
        });
        dayBox.querySelectorAll('input[type="time"]').forEach(input => {
            input.addEventListener('click', (e) => showTimePickerModal(e.target));
        });
        dayBox.querySelector('.clear-day-btn')?.addEventListener('click', () => clearDayData(dayBox.dataset.day));
    };

    const addDayCardEventListeners = () => {
        daysContainer.querySelectorAll('.day-box').forEach(addSingleDayCardEventListeners);
    };

    // --- ACTION HANDLERS ---
    const navigateMonth = (direction) => {
        soundManager.play('navigate');
        currentDate.setMonth(currentDate.getMonth() + direction);
        renderReportPage();
    };
    
    const handleClearMonthData = () => {
        if (!confirm('Are you sure you want to clear all data for this month? This action cannot be undone.')) return;
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        let updates = {};
        for (const key in workData) {
            const [dataYear, dataMonth] = key.split('-').map(Number);
            if (dataYear === year && dataMonth === month) {
                if(user) updates[`workData.${key}`] = deleteField();
                delete workData[key];
            }
        }
        if (user && Object.keys(updates).length > 0) {
            const userRef = doc(db, "users", user.uid);
            updateDoc(userRef, updates);
        } else {
            localStorage.setItem('workData', JSON.stringify(workData));
        }
        renderReportPage();
    };

    const handleBackup = () => {
        if (Object.keys(workData).length === 0) {
            showInfoModal('Backup Failed', 'There is no data to back up.');
            return;
        }
        const dataStr = JSON.stringify({ workData, reminders }, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `work_report_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        soundManager.play('success');
        showInfoModal('Backup Successful', 'Your data has been downloaded.');
    };
    
    // --- MODAL FUNCTIONS ---
    const showTimePickerModal = (targetInput) => {
        let [currentHour, currentMinute] = (targetInput.value || "09:00").split(':').map(Number);
        
        const modalContent = `
            <div class="time-picker-wheels">
                <ul id="hour-wheel" class="time-picker-wheel">${Array.from({length: 24}, (_, i) => `<li class="time-picker-item">${String(i).padStart(2,'0')}</li>`).join('')}</ul>
                <span class="time-picker-spacer">:</span>
                <ul id="minute-wheel" class="time-picker-wheel">${Array.from({length: 60}, (_, i) => `<li class="time-picker-item">${String(i).padStart(2,'0')}</li>`).join('')}</ul>
                 <div class="time-picker-selection-indicator"></div>
            </div>
            <button id="set-time-btn" class="w-full mt-4 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Set Time</button>
        `;
        openModal(createModal('Select Time', modalContent));

        const hourWheel = document.getElementById('hour-wheel');
        const minuteWheel = document.getElementById('minute-wheel');
        hourWheel.scrollTop = currentHour * 40; // 40px item height
        minuteWheel.scrollTop = currentMinute * 40;
        
        document.getElementById('set-time-btn').addEventListener('click', () => {
            soundManager.play('click');
            const hour = String(Math.round(hourWheel.scrollTop / 40) % 24).padStart(2, '0');
            const minute = String(Math.round(minuteWheel.scrollTop / 40) % 60).padStart(2, '0');
            targetInput.value = `${hour}:${minute}`;
            updateWorkData(targetInput.dataset.key, targetInput.dataset.field, targetInput.value);
            closeModal();
        });
    };

    const showExportPreview = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthName = months[month];
        let reportHTML = `<div class="bg-white p-8" id="export-content">
            <h1 class="text-2xl font-bold mb-4 text-center">Work Report for ${monthName} ${year}</h1>
            <table class="w-full border-collapse border border-gray-400 text-black">
                <thead><tr class="bg-gray-200">
                    <th class="border border-gray-300 p-2">Date</th>
                    <th class="border border-gray-300 p-2">Day</th>
                    <th class="border border-gray-300 p-2">In Time</th>
                    <th class="border border-gray-300 p-2">Out Time</th>
                    <th class="border border-gray-300 p-2">Total Hours</th>
                    <th class="border border-gray-300 p-2">Description</th>
                </tr></thead><tbody>`;

        for (let day = 1; day <= getDaysInMonth(year, month); day++) {
            const dateKey = `${year}-${month}-${day}`;
            const dayData = workData[dateKey] || {};
            const dayName = new Date(year, month, day).toLocaleDateString("en-US", { weekday: "short" });
            const hours = calculateHoursDifference(dayData.inTime, dayData.outTime);
            reportHTML += `<tr>
                <td class="border border-gray-300 p-2">${day}</td>
                <td class="border border-gray-300 p-2">${dayName}</td>
                <td class="border border-gray-300 p-2">${dayData.inTime || '-'}</td>
                <td class="border border-gray-300 p-2">${dayData.outTime || '-'}</td>
                <td class="border border-gray-300 p-2">${hours > 0 ? hours.toFixed(2) : '-'}</td>
                <td class="border border-gray-300 p-2 break-words">${dayData.description || '-'}</td>
            </tr>`;
        }
        reportHTML += `</tbody></table></div>
            <div class="mt-4 flex justify-end gap-2">
                <button id="download-pdf" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Download PDF</button>
            </div>`;
        openModal(createModal('Export Preview', reportHTML));
        document.getElementById('download-pdf').addEventListener('click', () => {
            soundManager.play('click');
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('export-content');
            html2canvas(content).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Work-Report-${monthName}-${year}.pdf`);
                soundManager.play('success');
            });
        });
    };

    // --- AUTH HANDLERS ---
    const handleLogin = (e) => {
        e.preventDefault(); soundManager.play('click');
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const errorEl = document.getElementById('auth-error');
        signInWithEmailAndPassword(auth, email, password)
            .catch(error => errorEl.textContent = error.message.replace('Firebase: ', ''));
    };

    const handleGoogleLogin = () => {
        soundManager.play('click');
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(error => {
            document.getElementById('auth-error').textContent = error.message.replace('Firebase: ', '');
        });
    };

    const handleSignUp = (e) => {
        e.preventDefault(); soundManager.play('click');
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        const errorEl = document.getElementById('signup-error');
        if (password !== confirmPassword) {
            errorEl.textContent = "Passwords do not match."; return;
        }
        createUserWithEmailAndPassword(auth, email, password)
            .then(userCredential => updateProfile(userCredential.user, { displayName: name }))
            .catch(error => errorEl.textContent = error.message.replace('Firebase: ', ''));
    };
    
    const handleForgotPassword = () => {
        const email = document.getElementById('auth-email').value;
        if (!email) {
            document.getElementById('auth-error').textContent = "Please enter your email address first."; return;
        }
        sendPasswordResetEmail(auth, email)
            .then(() => showInfoModal('Password Reset', 'A password reset link has been sent to your email.'))
            .catch(error => document.getElementById('auth-error').textContent = error.message.replace('Firebase: ', ''));
    };
    
    // --- MAIN RENDER/INITIALIZATION ---
    const renderDashboardPage = () => {
        renderAuthArea();
        renderProfileCard();
        renderTodaySummary();
        renderQuickActions();
        renderSettings();
        renderWeeklyGraph();
        document.getElementById('go-to-report-btn').addEventListener('click', () => showView('report-view'));
    };

    const renderReportPage = () => {
        renderReportHeader();
        renderDays();
        renderSummary();
    };

    const initializeAppView = async (currentUser) => {
        user = currentUser;
        const userRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(userRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            workData = data.workData || {};
            reminders = data.reminders || [];
        } else {
            // First time login
            await setDoc(userRef, { email: user.email, displayName: user.displayName });
            workData = {}; reminders = [];
        }
        showPage('main-app');
        showView('dashboard-view');
        loadingSpinner.classList.add('fade-out');
        setTimeout(() => loadingSpinner.classList.add('hidden'), 300);
    };

    const initSettings = () => {
        const savedSettings = localStorage.getItem('appSettings');
        if (savedSettings) settings = JSON.parse(savedSettings);
        if (settings.musicEnabled) ambientMusic.play().catch(e => console.log("Music autoplay blocked."));
    };

    // --- AUTH STATE CHANGE LISTENER ---
    onAuthStateChanged(auth, (currentUser) => {
        if (currentUser) {
            if(!user) initializeAppView(currentUser); // only run full init on first load
        } else {
            user = null;
            workData = JSON.parse(localStorage.getItem('workData') || '{}');
            reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            showPage('signin-page');
            renderSignInForm();
            loadingSpinner.classList.add('hidden');
        }
    });
    
    initSettings();
});
</script>
</body>
</html>
