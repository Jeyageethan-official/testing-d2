
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shopping Dashboard</title>

    <!-- 
      HOW TO CONNECT:
      1. Paste the generated code into an empty HTML file (e.g., index.html).
      2. Fill in your Firebase project configuration in the `firebaseConfig` object below.
      3. Open the HTML file in a web browser.
    -->

    <!-- 
      DEVELOPER QA CHECKLIST:
      [ ] Insert firebaseConfig below.
      [ ] Enable Firestore, Storage, and Authentication (Email/Password, Google) in Firebase console.
      [ ] Set Firestore & Storage security rules as per the examples.
      [ ] Add Google Vision & Translate API keys to enable real OCR/translation (optional).
      [ ] Test user sign-up, sign-in (Email & Google), and sign-out.
      [ ] Test Firestore CRUD: add, edit, delete shopping items.
      [ ] Test Backup: verify file in Storage and metadata in Firestore.
      [ ] Test Restore: verify data is overwritten correctly.
      [ ] Test Offline Mode: disconnect internet, add items, reconnect, and verify sync.
      [ ] Test OCR in MOCK_MODE=true and MOCK_MODE=false (if keys are set).
      [ ] Test Voice Input in a supported browser (e.g., Chrome).
      [ ] Test all export options (JSON, CSV, PDF, PNG).
      [ ] Test settings page functionality (profile update, theme change).
    -->

    <!-- 
      EXAMPLE FIRESTORE SECURITY RULES:
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          match /users/{userId}/{doc=**} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
    -->

    <!-- 
      EXAMPLE STORAGE SECURITY RULES:
      rules_version = '2';
      service firebase.storage {
        match /b/{bucket}/o {
          // Allow users to manage their own backups and profile pictures
          match /users/{userId}/{allPaths=**} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
    -->
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom CSS for Glassmorphism and animations -->
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(26, 32, 44, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-open {
            transform: translateX(0);
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
         /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">
    <div id="root"></div>

    <!-- External Libraries CDNs -->
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tesseract.js for OCR fallback -->
    <script src='https://unpkg.com/tesseract.js@2.1.0/dist/tesseract.min.js'></script>
    <!-- html2canvas & jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <!-- Main React Application Logic -->
    <script type="text/babel" data-type="module">
        // ===================================================================================
        // VIRTUAL FILE: index.tsx (Main Entry Point)
        // ===================================================================================
        
        // --- Constants and Configuration ---
        const MOCK_MODE = true; // Set to false to enable real API calls
        const GOOGLE_VISION_KEY = ''; // Optional: Add your Google Cloud Vision API key
        const GOOGLE_TRANSLATE_KEY = ''; // Optional: Add your Google Cloud Translate API key

        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your Firebase project's configuration object.
        const firebaseConfig = {
          apiKey: "AIzaSyDzaAqT7NRAyQhTNDh8GsMKlTKNmttzIWo",
          authDomain: "work-report-fe3da.firebaseapp.com",
          projectId: "work-report-fe3da",
          storageBucket: "work-report-fe3da.firebasestorage.app",
          messagingSenderId: "879340317679",
          appId: "1:879340317679:web:a28e2d3906bca3e927a41a",
          measurementId: "G-ZR8RGLKB77"
        };
        
        // --- React Imports ---
        const {
            useState,
            useEffect,
            createContext,
            useContext,
            useCallback,
            useRef,
            useMemo,
        } = React;

        // --- Library Imports ---
        const { jsPDF } = window.jspdf;

        // ===================================================================================
        // VIRTUAL FILE: context/AppContext.tsx
        // ===================================================================================
        const AppContext = createContext(null);

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [toasts, setToasts] = useState([]);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [theme, setTheme] = useState('auto');
            const [isOffline, setIsOffline] = useState(!navigator.onLine);
            const [syncQueue, setSyncQueue] = useState([]);

            const addToast = useCallback((message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 4000);
            }, []);
            
            useEffect(() => {
                const handleOnline = () => {
                    setIsOffline(false);
                    addToast("You are back online!", "success");
                };
                const handleOffline = () => {
                    setIsOffline(true);
                    addToast("You are offline. Changes will be synced later.", "warning");
                };

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [addToast]);
            
            useEffect(() => {
                if (user) {
                    const queue = JSON.parse(localStorage.getItem(`sync_queue_${user.uid}`) || '[]');
                    setSyncQueue(queue);
                }
            }, [user]);

            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
            }, [theme]);
            

            const value = {
                user, setUser,
                loading, setLoading,
                toasts, addToast,
                isSidebarOpen, setSidebarOpen,
                theme, setTheme,
                isOffline, syncQueue, setSyncQueue
            };

            return (
                <AppContext.Provider value={value}>
                    {children}
                </AppContext.Provider>
            );
        };
        
        const useAppContext = () => useContext(AppContext);

        // ===================================================================================
        // VIRTUAL FILE: services/firebaseService.js
        // ===================================================================================
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const GoogleAuthProvider = new firebase.auth.GoogleAuthProvider();

        // ===================================================================================
        // VIRTUAL FILE: components/common/*
        // ===================================================================================
        
        const Spinner = ({ size = '8', color = 'indigo' }) => (
            <div className={`animate-spin rounded-full h-${size} w-${size} border-b-2 border-${color}-500`}></div>
        );
        
        const FullPageLoader = () => (
          <div className="fixed inset-0 bg-gray-100 dark:bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <Spinner size="16" />
          </div>
        );

        const ToastContainer = () => {
            const { toasts } = useAppContext();
            const typeClasses = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
            };

            return (
                <div className="fixed bottom-5 right-5 z-50 space-y-3">
                    {toasts.map(toast => (
                        <div key={toast.id} className={`${typeClasses[toast.type]} text-white py-2 px-4 rounded-lg shadow-lg animate-fade-in-up`}>
                            {toast.message}
                        </div>
                    ))}
                </div>
            );
        };
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40" onClick={onClose}>
                    <div className="glass rounded-lg shadow-xl w-full max-w-md p-6 m-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">{title}</h2>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-500/20">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };
        
        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                dashboard: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />,
                list: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />,
                scan: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />,
                analytics: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />,
                backup: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />,
                settings: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />,
                menu: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />,
                user: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />,
                logout: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />,
                plus: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />,
            };
            return (
              <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  {icons[name] || icons['dashboard']}
              </svg>
            );
        };
        
        // ===================================================================================
        // VIRTUAL FILE: components/Auth.tsx
        // ===================================================================================
        const Auth = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { addToast } = useAppContext();

            const handleGoogleSignIn = async () => {
                setLoading(true);
                setError('');
                try {
                    const result = await auth.signInWithPopup(GoogleAuthProvider);
                    const user = result.user;
                    // Check if user is new
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) {
                        await db.collection('users').doc(user.uid).set({
                            profile: {
                                name: user.displayName,
                                email: user.email,
                                photoUrl: user.photoURL,
                                currency: 'USD',
                                preferences: { theme: 'auto' },
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            }
                        });
                        addToast('Welcome to Smart Shopping!', 'success');
                    } else {
                        addToast(`Welcome back, ${user.displayName}!`, 'success');
                    }
                } catch (err) {
                    setError(err.message);
                    addToast(err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };
            
            const handleEmailPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                        addToast('Logged in successfully!', 'success');
                    } else {
                        const result = await auth.createUserWithEmailAndPassword(email, password);
                        await result.user.updateProfile({ displayName: name });
                        await db.collection('users').doc(result.user.uid).set({
                            profile: {
                                name: name,
                                email: email,
                                photoUrl: '',
                                currency: 'USD',
                                preferences: { theme: 'auto' },
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            },
                            items: [], scans: [], backups: []
                        });
                        addToast('Account created successfully!', 'success');
                    }
                } catch (err) {
                    setError(err.message);
                    addToast(err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
                    <div className="w-full max-w-md p-8 space-y-8 glass rounded-2xl shadow-2xl">
                        <div>
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-white">
                                {isLogin ? 'Sign in to your account' : 'Create a new account'}
                            </h2>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleEmailPassword}>
                            {!isLogin && (
                                <input
                                    type="text"
                                    value={name}
                                    onChange={e => setName(e.target.value)}
                                    placeholder="Full Name"
                                    required
                                    className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                />
                            )}
                            <input
                                type="email"
                                value={email}
                                onChange={e => setEmail(e.target.value)}
                                placeholder="Email address"
                                required
                                className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            />
                            <input
                                type="password"
                                value={password}
                                onChange={e => setPassword(e.target.value)}
                                placeholder="Password"
                                required
                                className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            />
                            
                            {error && <p className="text-red-300 text-sm">{error}</p>}
                            
                            <div>
                                <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                                    {loading ? <Spinner size="5" color="white" /> : (isLogin ? 'Sign In' : 'Sign Up')}
                                </button>
                            </div>
                        </form>
                        
                        <div className="relative">
                          <div className="absolute inset-0 flex items-center">
                            <div className="w-full border-t border-gray-300/50"></div>
                          </div>
                          <div className="relative flex justify-center text-sm">
                            <span className="px-2 bg-gray-600/50 text-white rounded-md">Or continue with</span>
                          </div>
                        </div>

                        <div>
                            <button onClick={handleGoogleSignIn} disabled={loading} className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                <svg className="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 0C4.477 0 0 4.477 0 10c0 4.992 3.657 9.128 8.438 9.878v-6.987h-2.54V10h2.54V7.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V10h2.773l-.443 2.89h-2.33v6.988C16.343 19.128 20 14.992 20 10c0-5.523-4.477-10-10-10z" clipRule="evenodd"></path></svg>
                                <span className="ml-2">Google</span>
                            </button>
                        </div>
                        
                        <div className="text-sm text-center">
                            <a href="#" onClick={() => setIsLogin(!isLogin)} className="font-medium text-indigo-300 hover:text-indigo-200">
                                {isLogin ? "Don't have an account? Sign Up" : "Already have an account? Sign In"}
                            </a>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ===================================================================================
        // VIRTUAL FILE: components/MainLayout.tsx
        // ===================================================================================
        
        const Header = ({ onMenuClick }) => {
            const { user, isOffline, syncQueue } = useAppContext();
            
            const handleSignOut = () => auth.signOut();
            
            return (
                <header className="sticky top-0 z-30 w-full glass shadow-md">
                    <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center">
                                <button onClick={onMenuClick} className="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-500/20 md:hidden">
                                    <Icon name="menu" />
                                </button>
                                <div className="hidden md:block text-2xl font-bold text-gray-800 dark:text-white ml-4">
                                    Smart Shopping
                                </div>
                            </div>
                            <div className="flex items-center space-x-4">
                                {isOffline && <div className="text-red-500 font-semibold">Offline</div>}
                                {syncQueue.length > 0 && <div className="text-yellow-500 font-semibold animate-pulse">{syncQueue.length} pending</div>}
                                
                                <div className="relative group">
                                    <img src={user?.photoURL || `https://ui-avatars.com/api/?name=${user?.displayName}&background=random`} alt="User Avatar" className="w-10 h-10 rounded-full cursor-pointer" />
                                    <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-20 hidden group-hover:block">
                                        <div className="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 border-b dark:border-gray-600">
                                            Signed in as <br/><strong>{user?.displayName}</strong>
                                        </div>
                                        <a href="#" onClick={handleSignOut} className="flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            <Icon name="logout" className="w-5 h-5 mr-2" />
                                            Sign Out
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };
        
        const Sidebar = ({ currentPage, onNavigate }) => {
            const { isSidebarOpen, setSidebarOpen } = useAppContext();
            const navItems = [
              { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
              { id: 'list', label: 'Shopping List', icon: 'list' },
              { id: 'scan', label: 'Scanner', icon: 'scan' },
              { id: 'analytics', label: 'Analytics', icon: 'analytics' },
              { id: 'backup', label: 'Backups', icon: 'backup' },
              { id: 'settings', label: 'Settings', icon: 'settings' },
            ];
            
            return (
                <aside className={`fixed top-0 left-0 z-40 w-64 h-screen pt-20 glass md:translate-x-0 ${isSidebarOpen ? 'sidebar-open' : 'sidebar-closed'}`}>
                    <div className="h-full px-3 pb-4 overflow-y-auto">
                        <ul className="space-y-2 font-medium">
                           {navItems.map(item => (
                                <li key={item.id}>
                                    <a href="#" onClick={() => { onNavigate(item.id); setSidebarOpen(false); }}
                                       className={`flex items-center p-2 rounded-lg hover:bg-gray-500/20 ${currentPage === item.id ? 'bg-indigo-500/30 text-indigo-700 dark:text-indigo-300' : ''}`}>
                                        <Icon name={item.icon} className="w-6 h-6"/>
                                        <span className="ml-3">{item.label}</span>
                                    </a>
                                </li>
                           ))}
                        </ul>
                    </div>
                </aside>
            );
        };

        const MainLayout = ({ children }) => {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const { isSidebarOpen, setSidebarOpen } = useAppContext();
            
            const renderPage = () => {
                switch(currentPage) {
                    case 'dashboard': return <Dashboard />;
                    // TODO: Implement other pages
                    // case 'list': return <ShoppingList />;
                    // case 'scan': return <Scanner />;
                    // case 'analytics': return <Analytics />;
                    // case 'backup': return <Backups />;
                    // case 'settings': return <Settings />;
                    default: return <Dashboard />;
                }
            };
            
            return (
                <div className="flex h-screen">
                    <Sidebar currentPage={currentPage} onNavigate={setCurrentPage} />
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <Header onMenuClick={() => setSidebarOpen(!isSidebarOpen)} />
                        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900">
                            <div className="container mx-auto px-6 py-8">
                                {children(currentPage)}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        // ===================================================================================
        // VIRTUAL FILE: pages/Dashboard.tsx
        // ===================================================================================
        const Dashboard = () => {
            const { user } = useAppContext();
            // In a real app, these values would come from Firestore.
            const stats = {
                activeItems: 12,
                completedItems: 58,
                monthlySpend: 256.78,
                currency: 'USD',
            };
            
            return (
                <div>
                    <h3 className="text-3xl font-medium">Welcome back, {user?.displayName}!</h3>
                    <div className="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="glass p-5 rounded-lg">
                            <h4 className="text-lg font-semibold">Active Items</h4>
                            <p className="text-3xl font-bold mt-2">{stats.activeItems}</p>
                        </div>
                         <div className="glass p-5 rounded-lg">
                            <h4 className="text-lg font-semibold">Completed Items</h4>
                            <p className="text-3xl font-bold mt-2">{stats.completedItems}</p>
                        </div>
                         <div className="glass p-5 rounded-lg">
                            <h4 className="text-lg font-semibold">This Month's Spend</h4>
                            <p className="text-3xl font-bold mt-2">{stats.currency} {stats.monthlySpend}</p>
                        </div>
                         <div className="glass p-5 rounded-lg">
                            <h4 className="text-lg font-semibold">Quick Actions</h4>
                            <div className="mt-2 space-x-2">
                                <button className="bg-indigo-500 text-white px-3 py-1 rounded-md text-sm">New Item</button>
                                <button className="bg-green-500 text-white px-3 py-1 rounded-md text-sm">Scan Receipt</button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="glass p-5 rounded-lg">
                            <h4 className="text-lg font-semibold mb-4">Recent Items</h4>
                             {/* Mock recent items list */}
                            <ul>
                                <li className="flex justify-between py-2 border-b border-gray-500/20"><span>Milk</span><span>$3.50</span></li>
                                <li className="flex justify-between py-2 border-b border-gray-500/20"><span>Bread</span><span>$2.20</span></li>
                                <li className="flex justify-between py-2 border-b border-gray-500/20"><span>Eggs</span><span>$4.00</span></li>
                            </ul>
                        </div>
                        <div className="glass p-5 rounded-lg">
                             <h4 className="text-lg font-semibold mb-4">Spending Overview</h4>
                             <div className="h-64">{/* Placeholder for a chart */}
                                <p className="text-center mt-20">Chart will be displayed here.</p>
                             </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Placeholder pages
        const ShoppingList = () => <div className="glass p-6 rounded-lg"> <h2 className="text-2xl font-bold">Shopping List</h2> <p>This feature is under construction.</p> </div>;
        const Scanner = () => <div className="glass p-6 rounded-lg"> <h2 className="text-2xl font-bold">Scanner</h2> <p>This feature is under construction.</p> </div>;
        const Analytics = () => <div className="glass p-6 rounded-lg"> <h2 className="text-2xl font-bold">Analytics</h2> <p>This feature is under construction.</p> </div>;
        const Backups = () => <div className="glass p-6 rounded-lg"> <h2 className="text-2xl font-bold">Backups</h2> <p>This feature is under construction.</p> </div>;
        const Settings = () => <div className="glass p-6 rounded-lg"> <h2 className="text-2xl font-bold">Settings</h2> <p>This feature is under construction.</p> </div>;


        // ===================================================================================
        // VIRTUAL FILE: App.tsx (Root Component)
        // ===================================================================================
        const App = () => {
            const { user, setUser, loading, setLoading, addToast, setTheme } = useAppContext();

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDocRef = db.collection('users').doc(firebaseUser.uid);
                        const userDoc = await userDocRef.get();
                        
                        if (userDoc.exists) {
                            const profile = userDoc.data().profile;
                            setUser({
                                uid: firebaseUser.uid,
                                ...firebaseUser,
                                ...profile
                            });
                            setTheme(profile.preferences?.theme || 'auto');
                        } else {
                            // This might happen if user exists in Auth but not Firestore
                            addToast("User profile not found. Please sign up again.", "error");
                            auth.signOut();
                        }
                    } else {
                        setUser(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return <FullPageLoader />;
            }
            
            const renderPage = (page) => {
                switch(page) {
                    case 'dashboard': return <Dashboard />;
                    case 'list': return <ShoppingList />;
                    case 'scan': return <Scanner />;
                    case 'analytics': return <Analytics />;
                    case 'backup': return <Backups />;
                    case 'settings': return <Settings />;
                    default: return <Dashboard />;
                }
            };
            
            return (
                <>
                  <ToastContainer />
                  {user ? (
                      <MainLayout>
                        {currentPage => renderPage(currentPage)}
                      </MainLayout>
                  ) : (
                      <Auth />
                  )}
                </>
            );
        };

        // --- Final Render ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
          <AppProvider>
            <App />
          </AppProvider>
        );

    </script>
</body>
</html>
